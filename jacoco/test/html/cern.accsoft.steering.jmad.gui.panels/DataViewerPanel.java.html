<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataViewerPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jmad-gui</a> &gt; <a href="index.source.html" class="el_package">cern.accsoft.steering.jmad.gui.panels</a> &gt; <span class="el_source">DataViewerPanel.java</span></div><h1>DataViewerPanel.java</h1><pre class="source lang-java linenums">// @formatter:off
 /*******************************************************************************
 *
 * This file is part of JMad.
 * 
 * Copyright (c) 2008-2011, CERN. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * 
 ******************************************************************************/
// @formatter:on

package cern.accsoft.steering.jmad.gui.panels;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.event.ActionEvent;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import javax.swing.AbstractAction;
import javax.swing.Action;
import javax.swing.JButton;
import javax.swing.JPanel;

import cern.accsoft.steering.jmad.domain.result.tfs.TfsResult;
import cern.accsoft.steering.jmad.gui.actions.JMadGuiActions;
import cern.accsoft.steering.jmad.gui.data.TfsResultDataSet;
import cern.accsoft.steering.jmad.gui.dv.ChartFactory;
import cern.accsoft.steering.jmad.gui.icons.Icon;
import cern.accsoft.steering.jmad.gui.manage.DataSetManagerListener;
import cern.accsoft.steering.jmad.gui.manage.TfsDataSetManager;
import cern.accsoft.steering.util.gui.UserInteractor;
import cern.jdve.Chart;
import cern.jdve.Style;
import cern.jdve.data.DataSet;
import cern.jdve.data.DataSource;
import cern.jdve.data.DefaultDataSource;
import cern.jdve.renderer.StairsChartRenderer;
import cern.jdve.viewer.DVView;
import cern.jdve.viewer.DataView;
import cern.jdve.viewer.DataViewer;

<span class="fc" id="L58">public class DataViewerPanel extends JPanel implements DataSetManagerListener {</span>
<span class="fc" id="L59">    private final static Dimension PREFERRED_SIZE_DV = new Dimension(800, 300);</span>

    private static final long serialVersionUID = 1L;

    /** the integrated dataViewer */
<span class="fc" id="L64">    private DataViewer dataViewer = null;</span>

    /** the dataset - manager */
<span class="fc" id="L67">    private TfsDataSetManager tfsDataSetManager = null;</span>

    /** the class which provides factory methods for charts. */
    private ChartFactory chartFactory;

    /** the panel which is used to create plots */
    private PlotCreationPanel plotCreationPanel;

    /** the user interactor to show the dialog */
    private UserInteractor userInteractor;

    private JMadGuiActions jmadGuiActions;

    /**
     * the action to show the dialog for creating new plots
     */
<span class="fc" id="L83">    private final Action createPlotAction = new AbstractAction(&quot;Add view&quot;) {</span>
        private static final long serialVersionUID = 1L;

        {
<span class="fc" id="L87">            setToolTipText(&quot;Create a new chart-view.&quot;);</span>
<span class="fc" id="L88">            putValue(AbstractAction.SMALL_ICON, Icon.CHART.getImageIcon());</span>
<span class="fc" id="L89">        }</span>

        @Override
        public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L93">            getUserInteractor().showPanelDialog(getPlotCreationPanel(), DataViewerPanel.this);</span>
<span class="nc" id="L94">        }</span>
    };

    /**
     * creates all contained components
     */
    public void initComponents() {
<span class="fc" id="L101">        setLayout(new BorderLayout());</span>

        /*
         * The DataViewer
         */
<span class="fc" id="L106">        dataViewer = new DataViewer();</span>
        //dataViewer.setPreferredSize(PREFERRED_SIZE_DV);
<span class="fc" id="L108">        dataViewer.setExplorerVisible(true);</span>
<span class="fc" id="L109">        add(dataViewer, BorderLayout.CENTER);</span>

<span class="fc" id="L111">        JPanel buttonPanel = new JPanel(new GridBagLayout());</span>
<span class="fc" id="L112">        add(buttonPanel, BorderLayout.SOUTH);</span>

<span class="fc" id="L114">        GridBagConstraints constraints = new GridBagConstraints();</span>
<span class="fc" id="L115">        constraints.fill = GridBagConstraints.BOTH;</span>
<span class="fc" id="L116">        constraints.gridx = 0;</span>
<span class="fc" id="L117">        constraints.gridy = 0;</span>
<span class="fc" id="L118">        constraints.gridwidth = 1;</span>
<span class="fc" id="L119">        constraints.weightx = 0;</span>
<span class="fc" id="L120">        constraints.weighty = 1;</span>

<span class="fc" id="L122">        JButton btn = new JButton(this.createPlotAction);</span>
<span class="fc" id="L123">        buttonPanel.add(btn, constraints);</span>

        /*
         * the refresh - button
         */
<span class="fc" id="L128">        btn = new JButton(new AbstractAction(&quot;Refresh all views&quot;) {</span>
            private static final long serialVersionUID = 1L;

            @Override
            public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L133" title="All 2 branches missed.">                if (tfsDataSetManager != null) {</span>
<span class="nc" id="L134">                    tfsDataSetManager.refresh();</span>
                }
<span class="nc" id="L136">            }</span>
        });

<span class="fc" id="L139">        constraints.weightx = 1;</span>
<span class="fc" id="L140">        constraints.gridx++;</span>
<span class="fc" id="L141">        buttonPanel.add(btn, constraints);</span>

<span class="fc" id="L143">        btn = new JButton(new AbstractAction(&quot; &gt;&gt;&gt; ref &quot;) {</span>
            private static final long serialVersionUID = 9180066463817578987L;
            {
<span class="fc" id="L146">                putValue(AbstractAction.SHORT_DESCRIPTION,</span>
                        &quot;Stores the actual available data as reference for relative charts.&quot;);
<span class="fc" id="L148">            }</span>

            @Override
            public void actionPerformed(ActionEvent arg0) {
<span class="nc" id="L152">                getTfsDataSetManager().setAsReference();</span>
<span class="nc" id="L153">            }</span>
        });

<span class="fc" id="L156">        constraints.weightx = 0;</span>
<span class="fc" id="L157">        constraints.gridx++;</span>
<span class="fc" id="L158">        buttonPanel.add(btn, constraints);</span>

<span class="fc" id="L160">        JButton saveTwissButton = new JButton(jmadGuiActions.getSaveTwissAction());</span>
<span class="fc" id="L161">        constraints.weightx = 0;</span>
<span class="fc" id="L162">        constraints.gridx++;</span>
<span class="fc" id="L163">        buttonPanel.add(saveTwissButton, constraints);</span>

<span class="fc" id="L165">    }</span>

    /**
     * creates a new chart and adds it to the dataviewer.
     * 
     * @param name the name of the new chart
     * @param xLabel
     * @param dataSets
     */
    private void createChart(String name, String xLabel, Map&lt;Integer, List&lt;TfsResultDataSet&gt;&gt; dataSets) {
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (getChartFactory() == null) {</span>
<span class="nc" id="L176">            return;</span>
        }

<span class="nc" id="L179">        Chart chart = null;</span>
<span class="nc" id="L180">        int axisCount = 0;</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        for (Integer yAxis : dataSets.keySet()) {</span>

<span class="nc" id="L183">            List&lt;TfsResultDataSet&gt; aperDataSets = new ArrayList&lt;TfsResultDataSet&gt;();</span>
<span class="nc" id="L184">            DataSource dataSource = new DefaultDataSource();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            for (TfsResultDataSet dataSet : dataSets.get(yAxis)) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                if (dataSet.isApertureDataSet()) {</span>
<span class="nc" id="L187">                    aperDataSets.add(dataSet);</span>
                } else {
<span class="nc" id="L189">                    dataSource.addDataSet(dataSet);</span>
                }
<span class="nc" id="L191">            }</span>

<span class="nc" id="L193">            String yAxisTitle = &quot;Y&quot; + new Integer(yAxis + 1).toString();</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (chart == null) {</span>
<span class="nc" id="L196">                chart = getChartFactory().createMarkablePolyLineChart(dataSource);</span>
<span class="nc" id="L197">                chart.setName(name);</span>
<span class="nc" id="L198">                chart.getXScale()</span>
<span class="nc" id="L199">                        .setTitle(xLabel);</span>
<span class="nc" id="L200">                chart.getYScale()</span>
<span class="nc" id="L201">                        .setTitle(yAxisTitle);</span>
            } else {
<span class="nc" id="L203">                chart.addYAxis(true, false);</span>
<span class="nc" id="L204">                chart.getYScale(axisCount)</span>
<span class="nc" id="L205">                        .setTitle(yAxisTitle);</span>
<span class="nc" id="L206">                chart.getYScale(axisCount)</span>
<span class="nc" id="L207">                        .synchronizeWith(chart.getYScale(), true);</span>
<span class="nc" id="L208">                chart.addRenderer(axisCount, getChartFactory().createPolyLineRenderer(dataSource));</span>
            }

<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (aperDataSets.size() &gt; 0) {</span>
<span class="nc" id="L212">                DataSource aperDataSource = new DefaultDataSource(</span>
<span class="nc" id="L213">                        aperDataSets.toArray(new DataSet[aperDataSets.size()]));</span>
<span class="nc" id="L214">                StairsChartRenderer renderer = new StairsChartRenderer();</span>
<span class="nc" id="L215">                renderer.setDataSource(aperDataSource);</span>
<span class="nc" id="L216">                Style[] styles = new Style[aperDataSets.size()];</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                for (int i = 0; i &lt; aperDataSets.size(); i++) {</span>
<span class="nc" id="L218">                    styles[i] = new Style(Color.black);</span>
                }
<span class="nc" id="L220">                renderer.setStyles(styles);</span>
<span class="nc" id="L221">                chart.addRenderer(axisCount, renderer);</span>
            }
<span class="nc" id="L223">            axisCount++;</span>
<span class="nc" id="L224">        }</span>
<span class="nc" id="L225">        DVView dvView = new DVView(name);</span>
<span class="nc" id="L226">        dvView.addDataView(new DataView(chart));</span>
<span class="nc" id="L227">        dataViewer.addView(dvView);</span>
<span class="nc" id="L228">        dataViewer.setCurrentView(dvView);</span>
<span class="nc" id="L229">    }</span>

    /**
     * setter used for DI
     * 
     * @param tfsDataSetManager the tfsDataSetManager to set
     */
    public void setTfsDataSetManager(TfsDataSetManager tfsDataSetManager) {
<span class="fc" id="L237">        this.tfsDataSetManager = tfsDataSetManager;</span>
<span class="fc" id="L238">        tfsDataSetManager.addListener(this);</span>
<span class="fc" id="L239">    }</span>

    /**
     * @return the tfsDataSetManager
     */
    public TfsDataSetManager getTfsDataSetManager() {
<span class="nc" id="L245">        return tfsDataSetManager;</span>
    }

    /**
     * @param chartFactory the chartFactory to set
     */
    public void setChartFactory(ChartFactory chartFactory) {
<span class="fc" id="L252">        this.chartFactory = chartFactory;</span>
<span class="fc" id="L253">    }</span>

    /**
     * @return the chartFactory
     */
    private ChartFactory getChartFactory() {
<span class="nc" id="L259">        return chartFactory;</span>
    }

    @Override
    public void createdDataSets(String name, String xLabel, Map&lt;Integer, List&lt;TfsResultDataSet&gt;&gt; dataSets) {
<span class="nc" id="L264">        createChart(name, xLabel, dataSets);</span>
<span class="nc" id="L265">    }</span>

    public void setPlotCreationPanel(PlotCreationPanel plotCreationPanel) {
<span class="fc" id="L268">        this.plotCreationPanel = plotCreationPanel;</span>
<span class="fc" id="L269">    }</span>

    private PlotCreationPanel getPlotCreationPanel() {
<span class="nc" id="L272">        return plotCreationPanel;</span>
    }

    public void setUserInteractor(UserInteractor userInteractor) {
<span class="fc" id="L276">        this.userInteractor = userInteractor;</span>
<span class="fc" id="L277">    }</span>

    private UserInteractor getUserInteractor() {
<span class="nc" id="L280">        return userInteractor;</span>
    }

    @Override
    public void twissCalculated(TfsResult tfsResult) {
        /* nothing to do ss */
<span class="nc" id="L286">    }</span>

    public void setJmadGuiActions(JMadGuiActions jmadGuiActions) {
<span class="fc" id="L289">        this.jmadGuiActions = jmadGuiActions;</span>
<span class="fc" id="L290">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>